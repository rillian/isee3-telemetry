<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8>
<title>ISEE-3 Reboot!</title>
<link rel=stylesheet type=text/css href=envision.min.css>
<script src="/socket.io/socket.io.js"></script>
<script>
function start() {
  // Initialize plot;
  var series = [];
  var plot;
  function initialize_plot() {
    new envision.templates.TimeSeries({
      container: document.getElementById('plot'),
      data: {
        detail: series,
        summary: series
      }
    });
  }


  // Log data as it comes in.
  var elements = {};
  var socket = io();
  var graph_elements = [
    'hps_1_tc',
    'hps_2_tc',
    'hps_1_temp_supercom',
    'hps_2_temp_supercom',
  ];
  var maxpoints = 100;
  socket.on('data', function(data) {
    var result = data.result;
    var id = data.result.id;
    if (! (id in elements)) {
      Object.defineProperty(elements, id, {value: result, enumerable: true});
      elements[id].times = [];
      elements[id].values = [];
      // Add some elements to the plot as they come in.
      if (graph_elements.indexOf(id) != -1) {
        series.push([elements[id].times, elements[id].values]);
        if (!plot) {
          plot = initialize_plot();
        }
      }
      var ul = document.getElementById('data');
      var li = document.createElement('li');
      li.id = id;
      ul.appendChild(li);
    }
    // Convert timestamp to ISO 8601 and parse.
    var time = Date.parse(result.time.replace(' ', 'T'));
    elements[id].times.push(time);
    elements[id].values.push(result.value);
    var text = id;
    text += ' ' + result.value;
    text += ' ' + result.time;
    document.getElementById(id).textContent = text;
    // Remove old data to bound memory use.
    if (elements[id].times.length > maxpoints) {
      elements[id].times.shift();
      elements[id].values.shift();
    }
    if (plot) {
      plot.render();
    }
  });
}
addEventListener('load', start);
</script>
</head>
<body>
<h1>ISEE-3 Telemetry</h1>
  <div id=plot>
    <script src=envision.min.js></script>
  </div>
  <ul id=data></ul>
  <div id=footer>
    <p>Source available on <a href="https://github.com/rillian/isee3-telemetry/tree/dev">github</a>.</p>
  </div>
</body>
</html>
